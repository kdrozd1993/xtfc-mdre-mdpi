%-------------------------------------------------------------------------%
function [A, bb] = TFC_MDLE_Loss_5(setup)
%-------------------------------------------------------------------------%

% %
% 
% Authors: Kristofer Drozd
% Created: 12/06/2021
% 
% 
% Description:
% 
% This function generates the loss vector for the 3x3 Matrix Differential 
% Lyapunov Equation for the PINN/XTFC/TFC methodology.
% 
% 
% Inputs:
% 
% 
% setup - A structure representing inputs.
% 
% 
% Outputs:
% 
% A - A*x = b.
%
% b - A*x = b.
% 
% 
% Version:
% 
% 12/06/2021 - Initial completion.
% 
% %

A0 = setup.mdleVecMats.A0;
A0T = setup.mdleVecMats.A0T;
G = setup.mdreVecMats.G;
nx = sqrt(size(A0, 2));

n = setup.tfcVariables.n;
m = setup.tfcVariables.m;
t0 = setup.t0;
tf = setup.tf;
tau = setup.tau;

S0fvutr = setup.S0fvutr;

H = setup.tfcVariables.H;
Hd = setup.tfcVariables.Hd;

c = (tau(end) - tau(1)) / (tf - t0);

% CE = (H - ones(n,1)*H(end,:))*xi + S0fvutr;
% CEd = c*Hd*xi;

F = (H - ones(n,1)*H(end,:));
C = S0fvutr;

Fd = c*Hd;
Cd = zeros(size(C));

CeColInds = zeros(nx,nx);
CeColInds(1,:) = [1, 2, 3, 4, 5];
CeColInds(2,:) = [2, 6, 7, 8, 9];
CeColInds(3,:) = [3, 7, 10, 11, 12];
CeColInds(4,:) = [4, 8, 11, 13, 14];
CeColInds(5,:) = [5, 9, 12, 14, 15];

CeRowInds = zeros(nx,nx);
CeRowInds(1,:) = [1, 2, 3, 4, 5];
CeRowInds(2,:) = [2, 6, 7, 8, 9];
CeRowInds(3,:) = [3, 7, 10, 11, 12];
CeRowInds(4,:) = [4, 8, 11, 13, 14];
CeRowInds(5,:) = [5, 9, 12, 14, 15];

colInds = zeros(nx,nx);
colInds(1,:) = 1:1:5;
colInds(2,:) = 6:1:10;
colInds(3,:) = 11:1:15;
colInds(4,:) = 16:1:20;
colInds(5,:) = 21:1:25;

rowInds = zeros(nx,nx);
rowInds(1,:) = 1:5:25;
rowInds(2,:) = 2:5:25;
rowInds(3,:) = 3:5:25;
rowInds(4,:) = 4:5:25;
rowInds(5,:) = 5:5:25;

A = zeros((nx*(nx+1)/2)*n, (nx*(nx+1)/2)*m);
O = zeros(n, m);

A(1:n,:) = [-Fd+F.*A0T(:,1)+F.*A0(:,1), F.*A0T(:,6)+F.*A0(:,2), ...
    F.*A0T(:,11)+F.*A0(:,3), F.*A0T(:,16)+F.*A0(:,4), ...
    F.*A0T(:,21)+F.*A0(:,5), O, O, O, O, O, O, O, O, O, O];

A(n+1:2*n,:) = [F.*A0T(:,2), -Fd+F.*A0T(:,7)+F.*A0(:,1), ...
    F.*A0T(:,12), F.*A0T(:,17), F.*A0T(:,22), F.*A0(:,2), F.*A0(:,3), ...
    F.*A0(:,4), F.*A0(:,5), O, O, O, O, O, O];

A(2*n+1:3*n,:) = [F.*A0T(:,3), F.*A0T(:,8), -Fd+F.*A0T(:,13)+F.*A0(:,1), ...
    F.*A0T(:,18), F.*A0T(:,23), O, F.*A0(:,2), O, O, F.*A0(:,3), ...
    F.*A0(:,4), F.*A0(:,5), O, O, O];

A(3*n+1:4*n,:) = [F.*A0T(:,4), F.*A0T(:,9), F.*A0T(:,14), ...
    -Fd+F.*A0T(:,19)+F.*A0(:,1), F.*A0T(:,24), O, O, ...
    F.*A0(:,2), O, O, F.*A0(:,3), O, F.*A0(:,4), F.*A0(:,5), O];

A(4*n+1:5*n,:) = [F.*A0T(:,5), F.*A0T(:,10), F.*A0T(:,15), F.*A0T(:,20), ...
    -Fd+F.*A0T(:,25)+F.*A0(:,1), O, O, O, F.*A0(:,2), O, O, ...
    F.*A0(:,3), O, F.*A0(:,4), F.*A0(:,5)];

A(5*n+1:6*n,:) = [O, F.*A0T(:,2)+F.*A0(:,6), O, O, O, ...
    -Fd+F.*A0T(:,7)+F.*A0(:,7), F.*A0T(:,12)+F.*A0(:,8), ...
    F.*A0T(:,17)+F.*A0(:,9), F.*A0T(:,22)+F.*A0(:,10), O, O, O, O, O, O];

A(6*n+1:7*n,:) = [O, F.*A0T(:,3), F.*A0(:,6), O, O, F.*A0T(:,8), ...
    -Fd+F.*A0T(:,13)+F.*A0(:,7), F.*A0T(:,18), F.*A0T(:,23), ...
    F.*A0(:,8), F.*A0(:,9), F.*A0(:,10), O, O, O];

A(7*n+1:8*n,:) = [O, F.*A0T(:,4), O, F.*A0(:,6), O, F.*A0T(:,9), ...
    F.*A0T(:,14), -Fd+F.*A0T(:,19)+F.*A0(:,7), F.*A0T(:,24), O, ...
    F.*A0(:,8), O, F.*A0(:,9), F.*A0(:,10), O];

A(8*n+1:9*n,:) = [O, F.*A0T(:,5), O, O, F.*A0(:,6), F.*A0T(:,10), ...
    F.*A0T(:,15), F.*A0T(:,20), -Fd+F.*A0T(:,25)+F.*A0(:,7), O, O, ...
    F.*A0(:,8), O, F.*A0(:,9), F.*A0(:,10)];

A(9*n+1:10*n,:) = [O, O, F.*A0T(:,3)+F.*A0(:,11), O, O, O, ...
    F.*A0T(:,8)+F.*A0(:,12), O, O, -Fd+F.*A0T(:,13)+F.*A0(:,13), ...
    F.*A0T(:,18)+F.*A0(:,14), F.*A0T(:,23)+F.*A0(:,15), O, O, O];

A(10*n+1:11*n,:) = [O, O, F.*A0T(:,4), F.*A0(:,11), O, O, F.*A0T(:,9), ...
    F.*A0(:,12), O, F.*A0T(:,14), -Fd+F.*A0T(:,19)+F.*A0(:,13), ...
    F.*A0T(:,24), F.*A0(:,14), F.*A0(:,15), O];

A(11*n+1:12*n,:) = [O, O, F.*A0T(:,5), O, F.*A0(:,11), O, F.*A0T(:,10), ...
    O, F.*A0(:,12), F.*A0T(:,15), F.*A0T(:,20), ...
    -Fd+F.*A0T(:,25)+F.*A0(:,13), O, F.*A0(:,14), F.*A0(:,15)];

A(12*n+1:13*n,:) = [O, O, O, F.*A0T(:,4)+F.*A0(:,16), O, O, O, ...
    F.*A0T(:,9)+F.*A0(:,17), O, O, F.*A0T(:,14)+F.*A0(:,18), O, ...
    -Fd+F.*A0T(:,19)+F.*A0(:,19), F.*A0T(:,24)+F.*A0(:,20), O];

A(13*n+1:14*n,:) = [O, O, O, F.*A0T(:,5), F.*A0(:,16), O, O, ...
    F.*A0T(:,10), F.*A0(:,17), O, F.*A0T(:,15), F.*A0(:,18), ...
    F.*A0T(:,20), -Fd+F.*A0T(:,25)+F.*A0(:,19), F.*A0(:,20)];

A(14*n+1:15*n,:) = [O, O, O, O, F.*A0T(:,5)+F.*A0(:,21), O, O, O, ...
    F.*A0T(:,10)+F.*A0(:,22), O, O, F.*A0T(:,15)+F.*A0(:,23), O, ...
    F.*A0T(:,20)+F.*A0(:,24), -Fd+F.*A0T(:,25)+F.*A0(:,25)];

bb = zeros((nx*(nx+1)/2)*n, 1);
O = zeros(n, 1);

bb(1:n) = G(:,1) - A0T(:,1).*C(:,1)-A0(:,1).*C(:,1) - ...
                   A0T(:,6).*C(:,2)-A0(:,2).*C(:,2) - ...
                   A0T(:,11).*C(:,3)-A0(:,3).*C(:,3) - ...
                   A0T(:,16).*C(:,4)-A0(:,4).*C(:,4) - ...
                   A0T(:,21).*C(:,5)-A0(:,5).*C(:,5);
               
bb(n+1:2*n) = G(:,2) - A0T(:,2).*C(:,1)-A0(:,1).*C(:,2) - ...
                       A0T(:,7).*C(:,2)-A0(:,2).*C(:,6) - ...
                       A0T(:,12).*C(:,3)-A0(:,3).*C(:,7) - ...
                       A0T(:,17).*C(:,4)-A0(:,4).*C(:,8) - ...
                       A0T(:,22).*C(:,5)-A0(:,5).*C(:,9);
               
bb(2*n+1:3*n) = G(:,3) - A0T(:,3).*C(:,1)-A0(:,1).*C(:,3) - ...
                         A0T(:,8).*C(:,2)-A0(:,2).*C(:,7) - ...
                         A0T(:,13).*C(:,3)-A0(:,3).*C(:,10) - ...
                         A0T(:,18).*C(:,4)-A0(:,4).*C(:,11) - ...
                         A0T(:,23).*C(:,5)-A0(:,5).*C(:,12);
               
bb(3*n+1:4*n) = G(:,4) - A0T(:,4).*C(:,1)-A0(:,1).*C(:,4) - ...
                         A0T(:,9).*C(:,2)-A0(:,2).*C(:,8) - ...
                         A0T(:,14).*C(:,3)-A0(:,3).*C(:,11) - ...
                         A0T(:,19).*C(:,4)-A0(:,4).*C(:,13) - ...
                         A0T(:,24).*C(:,5)-A0(:,5).*C(:,14);
               
bb(4*n+1:5*n) = G(:,5) - A0T(:,5).*C(:,1)-A0(:,1).*C(:,5) - ...
                         A0T(:,10).*C(:,2)-A0(:,2).*C(:,9) - ...
                         A0T(:,15).*C(:,3)-A0(:,3).*C(:,12) - ...
                         A0T(:,20).*C(:,4)-A0(:,4).*C(:,14) - ...
                         A0T(:,25).*C(:,5)-A0(:,5).*C(:,15);
               
bb(5*n+1:6*n) = G(:,7) - A0T(:,2).*C(:,2)-A0(:,6).*C(:,2) - ...
                         A0T(:,7).*C(:,6)-A0(:,7).*C(:,6) - ...
                         A0T(:,12).*C(:,7)-A0(:,8).*C(:,7) - ...
                         A0T(:,17).*C(:,8)-A0(:,9).*C(:,8) - ...
                         A0T(:,22).*C(:,9)-A0(:,10).*C(:,9);
                     
bb(6*n+1:7*n) = G(:,8) - A0T(:,3).*C(:,2)-A0(:,6).*C(:,3) - ...
                         A0T(:,8).*C(:,6)-A0(:,7).*C(:,7) - ...
                         A0T(:,13).*C(:,7)-A0(:,8).*C(:,10) - ...
                         A0T(:,18).*C(:,8)-A0(:,9).*C(:,11) - ...
                         A0T(:,23).*C(:,9)-A0(:,10).*C(:,12);
                     
bb(7*n+1:8*n) = G(:,9) - A0T(:,4).*C(:,2)-A0(:,6).*C(:,4) - ...
                         A0T(:,9).*C(:,6)-A0(:,7).*C(:,8) - ...
                         A0T(:,14).*C(:,7)-A0(:,8).*C(:,11) - ...
                         A0T(:,19).*C(:,8)-A0(:,9).*C(:,13) - ...
                         A0T(:,24).*C(:,9)-A0(:,10).*C(:,14);
                     
bb(8*n+1:9*n) = G(:,10) - A0T(:,5).*C(:,2)-A0(:,6).*C(:,5) - ...
                         A0T(:,10).*C(:,6)-A0(:,7).*C(:,9) - ...
                         A0T(:,15).*C(:,7)-A0(:,8).*C(:,12) - ...
                         A0T(:,20).*C(:,8)-A0(:,9).*C(:,14) - ...
                         A0T(:,25).*C(:,9)-A0(:,10).*C(:,15);         
                     
bb(9*n+1:10*n) = G(:,13) - A0T(:,3).*C(:,3)-A0(:,11).*C(:,3) - ...
                            A0T(:,8).*C(:,7)-A0(:,12).*C(:,7) - ...
                            A0T(:,13).*C(:,10)-A0(:,13).*C(:,10) - ...
                            A0T(:,18).*C(:,11)-A0(:,14).*C(:,11) - ...
                            A0T(:,23).*C(:,12)-A0(:,15).*C(:,12);     
                        
bb(10*n+1:11*n) = G(:,14) - A0T(:,4).*C(:,3)-A0(:,11).*C(:,4) - ...
                            A0T(:,9).*C(:,7)-A0(:,12).*C(:,8) - ...
                            A0T(:,14).*C(:,10)-A0(:,13).*C(:,11) - ...
                            A0T(:,19).*C(:,11)-A0(:,14).*C(:,13) - ...
                            A0T(:,24).*C(:,12)-A0(:,15).*C(:,14);   
                        
bb(11*n+1:12*n) = G(:,15) - A0T(:,5).*C(:,3)-A0(:,11).*C(:,5) - ...
                            A0T(:,10).*C(:,7)-A0(:,12).*C(:,9) - ...
                            A0T(:,15).*C(:,10)-A0(:,13).*C(:,12) - ...
                            A0T(:,20).*C(:,11)-A0(:,14).*C(:,14) - ...
                            A0T(:,25).*C(:,12)-A0(:,15).*C(:,15);      
                        
bb(12*n+1:13*n) = G(:,19) - A0T(:,4).*C(:,4)-A0(:,16).*C(:,4) - ...
                            A0T(:,9).*C(:,8)-A0(:,17).*C(:,8) - ...
                            A0T(:,14).*C(:,11)-A0(:,18).*C(:,11) - ...
                            A0T(:,19).*C(:,13)-A0(:,19).*C(:,13) - ...
                            A0T(:,24).*C(:,14)-A0(:,20).*C(:,14);     
                        
bb(13*n+1:14*n) = G(:,20) - A0T(:,5).*C(:,4)-A0(:,16).*C(:,5) - ...
                            A0T(:,10).*C(:,8)-A0(:,17).*C(:,9) - ...
                            A0T(:,15).*C(:,11)-A0(:,18).*C(:,12) - ...
                            A0T(:,20).*C(:,13)-A0(:,19).*C(:,14) - ...
                            A0T(:,25).*C(:,14)-A0(:,20).*C(:,15);    
                        
bb(14*n+1:15*n) = G(:,25) - A0T(:,5).*C(:,5)-A0(:,21).*C(:,5) - ...
                            A0T(:,10).*C(:,9)-A0(:,22).*C(:,9) - ...
                            A0T(:,15).*C(:,12)-A0(:,23).*C(:,12) - ...
                            A0T(:,20).*C(:,14)-A0(:,24).*C(:,14) - ...
                            A0T(:,25).*C(:,15)-A0(:,25).*C(:,15);                            
                    
% L11 = -CEd(:,1) + dot(CE(:,CeColInds(1,:)),A0T(:,rowInds(1,:)),2) + dot(A0(:,colInds(1,:)),CE(:,CeRowInds(1,:)),2) - G(:,1);
% L12 = -CEd(:,2) + dot(CE(:,CeColInds(1,:)),A0T(:,rowInds(2,:)),2) + dot(A0(:,colInds(1,:)),CE(:,CeRowInds(2,:)),2) - G(:,2);
% L13 = -CEd(:,3) + dot(CE(:,CeColInds(1,:)),A0T(:,rowInds(3,:)),2) + dot(A0(:,colInds(1,:)),CE(:,CeRowInds(3,:)),2) - G(:,3);
% L14 = -CEd(:,4) + dot(CE(:,CeColInds(1,:)),A0T(:,rowInds(4,:)),2) + dot(A0(:,colInds(1,:)),CE(:,CeRowInds(4,:)),2) - G(:,4);
% L15 = -CEd(:,5) + dot(CE(:,CeColInds(1,:)),A0T(:,rowInds(5,:)),2) + dot(A0(:,colInds(1,:)),CE(:,CeRowInds(5,:)),2) - G(:,5);
% 
% %L21 = -CEd(:,6) + dot(CE(:,colInds(2,:)),A0T(:,rowInds(1,:)),2) + dot(A0(:,colInds(2,:)),CE(:,rowInds(1,:)),2) - G(:,6);
% L22 = -CEd(:,6) + dot(CE(:,CeColInds(2,:)),A0T(:,rowInds(2,:)),2) + dot(A0(:,colInds(2,:)),CE(:,CeRowInds(2,:)),2) - G(:,7);
% L23 = -CEd(:,7) + dot(CE(:,CeColInds(2,:)),A0T(:,rowInds(3,:)),2) + dot(A0(:,colInds(2,:)),CE(:,CeRowInds(3,:)),2) - G(:,8);
% L24 = -CEd(:,8) + dot(CE(:,CeColInds(2,:)),A0T(:,rowInds(4,:)),2) + dot(A0(:,colInds(2,:)),CE(:,CeRowInds(4,:)),2) - G(:,9);
% L25 = -CEd(:,9) + dot(CE(:,CeColInds(2,:)),A0T(:,rowInds(5,:)),2) + dot(A0(:,colInds(2,:)),CE(:,CeRowInds(5,:)),2) - G(:,10);
% 
% %L31 = -CEd(:,11) + dot(CE(:,colInds(3,:)),A0T(:,rowInds(1,:)),2) + dot(A0(:,colInds(3,:)),CE(:,rowInds(1,:)),2) - G(:,11);
% %L32 = -CEd(:,12) + dot(CE(:,colInds(3,:)),A0T(:,rowInds(2,:)),2) + dot(A0(:,colInds(3,:)),CE(:,rowInds(2,:)),2) - G(:,12);
% L33 = -CEd(:,10) + dot(CE(:,CeColInds(3,:)),A0T(:,rowInds(3,:)),2) + dot(A0(:,colInds(3,:)),CE(:,CeRowInds(3,:)),2) - G(:,13);
% L34 = -CEd(:,11) + dot(CE(:,CeColInds(3,:)),A0T(:,rowInds(4,:)),2) + dot(A0(:,colInds(3,:)),CE(:,CeRowInds(4,:)),2) - G(:,14);
% L35 = -CEd(:,12) + dot(CE(:,CeColInds(3,:)),A0T(:,rowInds(5,:)),2) + dot(A0(:,colInds(3,:)),CE(:,CeRowInds(5,:)),2) - G(:,15);
% 
% %L41 = -CEd(:,16) + dot(CE(:,colInds(4,:)),A0T(:,rowInds(1,:)),2) + dot(A0(:,colInds(4,:)),CE(:,rowInds(1,:)),2) - G(:,16);
% %L42 = -CEd(:,17) + dot(CE(:,colInds(4,:)),A0T(:,rowInds(2,:)),2) + dot(A0(:,colInds(4,:)),CE(:,rowInds(2,:)),2) - G(:,17);
% %L43 = -CEd(:,18) + dot(CE(:,colInds(4,:)),A0T(:,rowInds(3,:)),2) + dot(A0(:,colInds(4,:)),CE(:,rowInds(3,:)),2) - G(:,18);
% L44 = -CEd(:,13) + dot(CE(:,CeColInds(4,:)),A0T(:,rowInds(4,:)),2) + dot(A0(:,colInds(4,:)),CE(:,CeRowInds(4,:)),2) - G(:,19);
% L45 = -CEd(:,14) + dot(CE(:,CeColInds(4,:)),A0T(:,rowInds(5,:)),2) + dot(A0(:,colInds(4,:)),CE(:,CeRowInds(5,:)),2) - G(:,20);
% 
% %L51 = -CEd(:,21) + dot(CE(:,colInds(5,:)),A0T(:,rowInds(1,:)),2) + dot(A0(:,colInds(5,:)),CE(:,rowInds(1,:)),2) - G(:,21);
% %L52 = -CEd(:,22) + dot(CE(:,colInds(5,:)),A0T(:,rowInds(2,:)),2) + dot(A0(:,colInds(5,:)),CE(:,rowInds(2,:)),2) - G(:,22);
% %L53 = -CEd(:,23) + dot(CE(:,colInds(5,:)),A0T(:,rowInds(3,:)),2) + dot(A0(:,colInds(5,:)),CE(:,rowInds(3,:)),2) - G(:,23);
% %L54 = -CEd(:,24) + dot(CE(:,colInds(5,:)),A0T(:,rowInds(4,:)),2) + dot(A0(:,colInds(5,:)),CE(:,rowInds(4,:)),2) - G(:,24);
% L55 = -CEd(:,15) + dot(CE(:,CeColInds(5,:)),A0T(:,rowInds(5,:)),2) + dot(A0(:,colInds(5,:)),CE(:,CeRowInds(5,:)),2) - G(:,25);
% 
% % loss = [L11; L12; L13; L14; L15; ...
% %         L21; L22; L23; L24; L25; ...
% %         L31; L32; L33; L34; L35; ...
% %         L41; L42; L43; L44; L45; ...
% %         L51; L52; L53; L54; L55];
%     
% loss = [L11; L12; L13; L14; L15; ...
%         L22; L23; L24; L25; ...
%         L33; L34; L35; ...
%         L44; L45; ...
%         L55];

end